# Suricata Auto Block Dashboard â€” by Levi (github.com/LEVI6957)
services:
  suricata:
    image: jasonish/suricata:latest
    container_name: suricata_main
    restart: unless-stopped
    network_mode: "host"
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    volumes:
      - ./logs:/var/log/suricata # Mount log ke host
      - suricata-rules:/var/lib/suricata
      - suricata-config:/etc/suricata
    # Interface dibaca otomatis dari .env (di-set oleh install.sh)
    command: -i ${NET_IFACE:-enp86s0}

  evebox:
    image: jasonish/evebox:latest
    container_name: evebox_ui
    restart: on-failure
    ports:
      - "5636:5636"
    volumes:
      - ./logs:/var/log/suricata:ro # Baca log dari host (read-only)
      - evebox-data:/var/lib/evebox
    command: >
      server --datastore sqlite --data-directory /var/lib/evebox --eve-directory /var/log/suricata --host 0.0.0.0
    depends_on:
      - suricata

  auto_block:
    build:
      context: ./auto_block
      dockerfile: Dockerfile
    container_name: auto_block
    restart: unless-stopped
    network_mode: "host"
    cap_add:
      - NET_ADMIN
    privileged: true
    volumes:
      - ./logs:/var/log/suricata:ro
      - /etc/ufw:/etc/ufw
      - /lib/ufw:/lib/ufw:ro
      - ./auto_block/blocked_ips.log:/app/blocked_ips.log
      - ./auto_block/alert_counts.json:/app/alert_counts.json
    environment:
      - EVE_LOG_PATH=/var/log/suricata/eve.json
      - BLOCK_THRESHOLD=${BLOCK_THRESHOLD:-3}
      - CHECK_INTERVAL=${CHECK_INTERVAL:-10}
      - ALERT_SEVERITY=${ALERT_SEVERITY:-2}
      - DASHBOARD_URL=http://127.0.0.1:${DASHBOARD_PORT:-8080}
    depends_on:
      - suricata

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: suricata_dashboard
    restart: unless-stopped
    network_mode: "host"
    cap_add:
      - NET_ADMIN
    privileged: true
    volumes:
      - ./logs:/var/log/suricata:ro # Baca eve.json
      - ./auto_block/blocked_ips.log:/app/blocked_ips.log # Baca log IP diblok
      - ./auto_block/alert_counts.json:/app/alert_counts.json # Sync state
      - ./dashboard/settings.json:/app/settings.json # Persistent settings
      - /etc/ufw:/etc/ufw # Akses UFW host
      - /lib/ufw:/lib/ufw:ro # Akses lib UFW host
    environment:
      - EVE_LOG_PATH=/var/log/suricata/eve.json
      - BLOCKED_LOG=/app/blocked_ips.log
      - ALERT_COUNTS=/app/alert_counts.json
    command: >
      uvicorn app:app --host ${SERVER_IP:-0.0.0.0} --port ${DASHBOARD_PORT:-8080} --log-level info
    depends_on:
      - suricata

volumes:
  suricata-rules:
  suricata-config:
  evebox-data:
